# Story 1.3: Set Up Vercel Deployment Pipeline and Environment Configuration

## Status

Approved

## Story

**As a** developer,
**I want** the project connected to Vercel with automatic deployments and environment variables configured,
**so that** code changes are automatically deployed and the site is accessible online with proper configuration for future integrations.

## Acceptance Criteria

1. Project connected to Vercel account
2. Automatic deployments configured for main branch
3. Preview deployments enabled for pull requests
4. Environment variables configured in Vercel dashboard (placeholders for future CMS/analytics)
5. `.env.local.example` file created documenting required environment variables
6. Initial deployment to Vercel successful and accessible via URL
7. Build logs show no errors or warnings

## Tasks / Subtasks

- [ ] Push project to GitHub repository (AC: 1, 2)
  - [ ] Create new GitHub repository for KBM_Design
  - [ ] Add GitHub remote to local Git repository
  - [ ] Push initial commit to main branch
  - [ ] Verify repository is accessible on GitHub

- [ ] Connect project to Vercel (AC: 1, 2, 3)
  - [ ] Log in to Vercel account (or create free account)
  - [ ] Import GitHub repository to Vercel
  - [ ] Configure project settings: Framework preset (Next.js), Build command, Output directory
  - [ ] Enable automatic deployments from main branch
  - [ ] Enable preview deployments for all branches/PRs
  - [ ] Verify Vercel project dashboard shows correct settings

- [ ] Configure placeholder environment variables (AC: 4)
  - [ ] In Vercel dashboard, add environment variable placeholders:
    - `NEXT_PUBLIC_SITE_URL` (production URL)
    - `CMS_API_URL` (placeholder for future Sanity/Strapi)
    - `CMS_API_TOKEN` (placeholder for future CMS auth)
    - `ANALYTICS_ID` (placeholder for future analytics)
  - [ ] Set appropriate scopes: Production, Preview, Development
  - [ ] Document purpose of each variable

- [ ] Create .env.local.example file (AC: 5)
  - [ ] Create `.env.local.example` in project root
  - [ ] Document all environment variables with descriptions and example values
  - [ ] Add instructions for local development setup
  - [ ] Commit .env.local.example to Git (safe since no real values)

- [ ] Trigger initial deployment (AC: 6, 7)
  - [ ] Push changes to main branch to trigger deployment
  - [ ] Monitor Vercel deployment logs in real-time
  - [ ] Verify build completes successfully with no errors
  - [ ] Check for TypeScript errors, ESLint warnings in build logs
  - [ ] Verify deployment status shows "Ready"

- [ ] Verify deployment and enable Vercel features (AC: 6, 7)
  - [ ] Access deployed site via Vercel URL
  - [ ] Test homepage renders correctly in production
  - [ ] Verify dark theme CSS variables are applied
  - [ ] Enable Vercel Analytics (if available in free tier)
  - [ ] Configure Vercel Speed Insights
  - [ ] Document production URL in README.md

- [ ] Configure Next.js for production optimizations
  - [ ] Review `next.config.js` for production settings
  - [ ] Ensure ISR revalidation is configured (prepare for future)
  - [ ] Verify image optimization is enabled
  - [ ] Confirm serverless functions are supported (for future contact form)

## Dev Notes

### Project Context

This is **Story 1.3** - the final story in Epic 1 (Development Setup & Foundation). Stories 1.1 and 1.2 have prepared the Next.js project with dependencies, structure, tooling, and theming. This story connects everything to Vercel for automatic deployments.

**Dependencies on Previous Stories:**

- Story 1.1: Next.js project initialized with all dependencies
- Story 1.2: Project structure, Git, ESLint, Prettier, Tailwind configured
- Git repository should be initialized with initial commits

**This Story Completes Epic 1:**
After this story, the development foundation is ready for feature work in Epic 2.

### Vercel Platform Overview

[Source: docs/architecture/4-infrastructure-deployment.md#hosting-cd]

**Why Vercel:**

- **Native Next.js Support** - Built by the creators of Next.js
- **Automatic Deployments** - Git push triggers builds and deploys
- **ISR Support** - Built-in Incremental Static Regeneration for project pages
- **Edge Rendering** - Low latency edge functions
- **Serverless Functions** - API routes for future contact form
- **CDN Distribution** - Global content delivery
- **Free Tier** - Generous free tier for personal projects

**Alternative:** Netlify (similar capabilities, choose based on preference)

### GitHub Repository Setup

**Repository Requirements:**

- Repository name: `KBM_Design` (or user preference)
- Visibility: Public or Private (private recommended during development)
- Initialize with: None (already have local Git)

**Git Remote Setup:**

```bash
git remote add origin https://github.com/[username]/KBM_Design.git
git branch -M main
git push -u origin main
```

### Vercel Project Configuration

**Import Settings:**

- **Framework Preset:** Next.js (auto-detected)
- **Build Command:** `npm run build` (default)
- **Output Directory:** `.next` (default)
- **Install Command:** `npm install` (or `pnpm install` if using pnpm)
- **Node.js Version:** 18.x or 20.x (latest LTS)

**Deployment Settings:**

- **Production Branch:** `main`
- **Automatic Deployments:** Enabled for main
- **Preview Deployments:** Enabled for all branches and PRs
- **Build & Development Settings:** Use defaults

### Environment Variables Configuration

[Source: docs/architecture/3-content-data-layer.md, docs/architecture/5-analytics-monitoring.md]

**Required Placeholder Variables:**

These are placeholders for future stories. They won't be used yet but should be configured now:

1. **NEXT_PUBLIC_SITE_URL**
   - Description: Production URL of the site
   - Value: `https://kbm-design.vercel.app` (or custom domain)
   - Scope: Production, Preview, Development
   - Public: Yes (NEXT*PUBLIC* prefix makes it available client-side)

2. **CMS_API_URL**
   - Description: Headless CMS API endpoint (Sanity/Strapi)
   - Value: `https://placeholder.sanity.studio/api` (placeholder)
   - Scope: Production, Preview, Development
   - Public: No (server-side only)

3. **CMS_API_TOKEN**
   - Description: Authentication token for CMS API
   - Value: `placeholder-token` (will be replaced in Epic 4)
   - Scope: Production, Preview, Development
   - Public: No (server-side only)

4. **ANALYTICS_ID**
   - Description: Analytics provider ID (Google Analytics, Vercel Analytics)
   - Value: `placeholder-id` (will be replaced when analytics configured)
   - Scope: Production
   - Public: Yes (needs client-side access)

**Important Notes:**

- Variables without `NEXT_PUBLIC_` prefix are server-side only
- Never commit real API keys or tokens to Git
- Use different values for Production vs Preview/Development when appropriate

### .env.local.example File Structure

Create this file to document environment variables for team members:

```bash
# KBM.Design Environment Variables
# Copy this file to .env.local for local development
# Do NOT commit .env.local - it's in .gitignore

# Site Configuration
NEXT_PUBLIC_SITE_URL=http://localhost:3000

# CMS Configuration (Epic 4)
# Will be configured when CMS is set up
CMS_API_URL=https://placeholder.sanity.studio/api
CMS_API_TOKEN=your-cms-token-here

# Analytics (Epic 5)
# Will be configured when analytics are integrated
ANALYTICS_ID=your-analytics-id-here

# Instructions:
# 1. Copy this file to .env.local
# 2. Update values as needed for local development
# 3. For production, configure these in Vercel dashboard
```

### Vercel Analytics and Speed Insights

[Source: docs/architecture/5-analytics-monitoring.md]

**Vercel Analytics (Free Tier):**

- Provides basic Web Vitals tracking
- No additional configuration needed
- Enable in Vercel dashboard under Analytics tab

**Vercel Speed Insights:**

- Real User Monitoring (RUM) for performance
- Install package: `@vercel/speed-insights`
- Add to root layout in future story (not required for this story)

**Future Analytics Integration:**
The architecture mentions:

- Google Analytics or similar for detailed user behavior tracking
- Sentry for error tracking
- Custom event tracking for project interactions

These will be configured in later epics. For now, basic Vercel Analytics is sufficient.

### Next.js Production Configuration

**next.config.js Considerations:**

For this story, verify default config is appropriate:

```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  // App Router is default in Next.js 14+
  // Image optimization enabled by default
  // Future: ISR revalidation will be configured per-page
  // Future: Serverless functions work automatically in /app/api
}

module.exports = nextConfig
```

**No changes needed in this story** - defaults are correct. Future stories will add:

- Image domains for CMS media (Epic 4)
- ISR revalidation intervals (Epic 3)
- Custom headers for CSP (security enhancement)

### Serverless Functions Support

[Source: docs/architecture/4-infrastructure-deployment.md#serverless-functions]

Vercel automatically supports Next.js API routes as serverless functions:

- Place functions in `/app/api/` directory
- Each route.ts becomes a serverless endpoint
- Used for secure server-side operations (contact form, CMS queries)
- Will be implemented in future epics

**No configuration needed in this story** - just verify support is available.

### CDN and Caching

[Source: docs/architecture/4-infrastructure-deployment.md#cdn-caching]

Vercel CDN handles:

- Static asset distribution globally
- Generated pages cached at edge
- ISR page revalidation
- Automatic cache invalidation on new deployments

**Default settings are optimal** - no configuration needed.

### Performance Baseline

[Source: docs/architecture/6-performance-accessibility-considerations.md]

After deployment, verify performance meets baseline:

- **Lighthouse Score:** 90+ (target)
- **Initial Bundle Size:** <200KB gzipped for main bundle
- **First Contentful Paint (FCP):** <1.5s
- **Time to Interactive (TTI):** <3s

Run Lighthouse audit after deployment to establish baseline metrics.

### Security Considerations

[Source: docs/architecture/7-security-privacy.md]

**Content Security Policy (CSP):**

- Will be configured in future story with custom headers
- Vercel provides basic security headers by default

**Environment Variable Security:**

- Never expose sensitive values client-side
- Use `NEXT_PUBLIC_` prefix only for safe, public values
- Rotate tokens regularly in production

**Git Security:**

- `.env.local` is in .gitignore
- Only `.env.local.example` with placeholder values is committed

### Testing Standards

**Testing for This Story:**

This is a deployment configuration story. Testing focuses on verification:

1. **Deployment Success Verification:**
   - Check Vercel deployment logs show "Ready"
   - Verify no build errors or TypeScript errors
   - Confirm no ESLint warnings in production build

2. **Site Accessibility:**
   - Access production URL in browser
   - Verify homepage renders correctly
   - Check mobile viewport rendering

3. **CSS Theme Verification:**
   - Inspect DevTools - verify CSS variables are applied
   - Check dark theme background/foreground colors
   - Verify Tailwind styles are compiled and purged

4. **Performance Baseline:**
   - Run Lighthouse audit (Performance, Accessibility, Best Practices, SEO)
   - Document baseline scores for future comparison
   - Verify initial bundle size is reasonable

5. **Environment Variables:**
   - Verify placeholder variables are set in Vercel dashboard
   - Check `.env.local.example` is committed to Git
   - Confirm `.env.local` is NOT in Git (if created locally)

6. **Automatic Deployment:**
   - Make trivial change (e.g., update README)
   - Push to main branch
   - Verify Vercel automatically triggers new deployment

**No formal testing code required** - manual verification of deployment infrastructure.

### Important Notes from Previous Stories

**From Story 1.1:**

- Node.js 18+ required
- Next.js 14+ with TypeScript and App Router
- All dependencies installed

**From Story 1.2:**

- Git repository initialized
- ESLint and Prettier configured
- Tailwind CSS with theme variables
- Pre-commit hooks active

**Pre-Deployment Checklist:**
Before connecting to Vercel, ensure:

- [ ] No uncommitted changes
- [ ] All files formatted and linted
- [ ] `npm run build` succeeds locally
- [ ] `npm run lint` shows no errors

### Troubleshooting Common Issues

**Issue: Build fails on Vercel but works locally**

- Check Node.js version matches (use 18.x or 20.x)
- Verify all dependencies are in package.json (not just devDependencies if needed)
- Check build logs for specific TypeScript or ESLint errors

**Issue: CSS styles not applied**

- Ensure globals.css is imported in root layout
- Verify Tailwind config paths include all component directories
- Check for CSS purging issues with custom classes

**Issue: Environment variables not working**

- NEXT*PUBLIC* prefix required for client-side access
- Rebuild required after adding/changing Vercel env vars
- Check variable scopes (Production vs Preview vs Development)

### Next Steps After This Story

With Epic 1 complete, the project is ready for feature development:

**Epic 2: Core Gallery & Navigation**

- 3D gallery component with React Three Fiber
- Floating navigation bar
- Category filtering

**Epic 3: Dynamic Project Pages**

- Project page routing and templates
- Media embedding (images, videos)
- Project metadata display

**Epic 4: CMS Integration**

- Sanity or Strapi setup
- Content schemas
- Data fetching and ISR

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-10-03 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

_TBD_

### File List

_TBD_

## QA Results

_This section will be populated by the QA Agent after story completion._
